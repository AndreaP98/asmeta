<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RuleSubstitution.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">report.aggregate</a> &gt; <a href="../index.html" class="el_bundle">asmeta.simulator</a> &gt; <a href="index.source.html" class="el_package">org.asmeta.simulator</a> &gt; <span class="el_source">RuleSubstitution.java</span></div><h1>RuleSubstitution.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2005, 2006 ASMETA group (http://asmeta.sourceforge.net)
 * License Information: http://asmeta.sourceforge.net/licensing/
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License version 2 as
 *   published by the Free Software Foundation.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   You should have received a copy of the GNU General Public License
 *   along with this program; if not, write to the Free Software
 *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301
 *   USA
 *
 *   http://www.gnu.org/licenses/gpl.txt
 *
 *
 *******************************************************************************/

/*
 * RuleSubstitution.java
 *
 * Created on 27 giugno 2006, 9.45
 *
 * To change this template, choose Tools | Template Manager
 * and open the template in the editor.
 */

package org.asmeta.simulator;


import java.util.ArrayList;
import java.util.Collection;
import java.util.List;

import org.apache.log4j.Logger;
import org.asmeta.parser.util.RulePrinter;

import asmeta.terms.basicterms.FunctionTerm;
import asmeta.terms.basicterms.LocationTerm;
import asmeta.terms.basicterms.Term;
import asmeta.terms.basicterms.TupleTerm;
import asmeta.terms.basicterms.VariableTerm;
import asmeta.transitionrules.basictransitionrules.BlockRule;
import asmeta.transitionrules.basictransitionrules.ChooseRule;
import asmeta.transitionrules.basictransitionrules.ConditionalRule;
import asmeta.transitionrules.basictransitionrules.ExtendRule;
import asmeta.transitionrules.basictransitionrules.ForallRule;
import asmeta.transitionrules.basictransitionrules.LetRule;
import asmeta.transitionrules.basictransitionrules.MacroCallRule;
import asmeta.transitionrules.basictransitionrules.Rule;
import asmeta.transitionrules.basictransitionrules.SkipRule;
import asmeta.transitionrules.basictransitionrules.TermAsRule;
import asmeta.transitionrules.basictransitionrules.UpdateRule;
import asmeta.transitionrules.derivedtransitionrules.CaseRule;
import asmeta.transitionrules.derivedtransitionrules.IterativeWhileRule;
import asmeta.transitionrules.turbotransitionrules.SeqRule;
import asmeta.transitionrules.turbotransitionrules.TurboCallRule;
import asmeta.transitionrules.turbotransitionrules.TurboReturnRule;

/**
 * Given a term assignment, i.e, an assignment between variables (the formal 
 * parameters of a rule) and terms (to substitute to variables), this class 
 * provides methods which do substitutions in order to obtain a new rule.
 *
 */
public class RuleSubstitution extends TermSubstitution {

<span class="nc" id="L73">	private static Logger logger = Logger.getLogger(RuleSubstitution.class);</span>
	
	
	/**
	 * Returns a string representation of a rule.
	 * 
	 */
<span class="nc" id="L80">	private static RulePrinter printer = new RulePrinter(true);</span>

    /**
     * Constructor.
     *
     * @param params term assignment
     */
    public RuleSubstitution(TermAssignment params) {
<span class="nc" id="L88">    	super(params);</span>
<span class="nc" id="L89">    }</span>

    /**
     * Copy constructor.
     * 
     */
    public RuleSubstitution(RuleSubstitution substitution) {
<span class="nc" id="L96">    	super(substitution);</span>
<span class="nc" id="L97">    }</span>

	/**
	 * Does substitutions on the rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public Rule visit(Rule rule) {
<span class="nc" id="L106">        return (Rule) visit((Object)rule);</span>
    }

	/**
	 * Does substitutions on the skip rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public SkipRule visit(SkipRule skipRule) {
<span class="nc" id="L116">    	logger.debug(&quot;&lt;SkipRule&gt;&quot;);</span>
<span class="nc" id="L117">    	logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(skipRule) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L118">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(skipRule) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L119">    	logger.debug(&quot;&lt;/SkipRule&gt;&quot;);</span>
<span class="nc" id="L120">        return ruleFactory.createSkipRule();</span>
    }

	/**
	 * Does substitutions on the update rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public UpdateRule visit(UpdateRule updateRule) {
<span class="nc" id="L130">    	logger.debug(&quot;&lt;UpdateRule&gt;&quot;);</span>
<span class="nc" id="L131">        logger.debug(&quot;&lt;Location&gt;&quot;);</span>
<span class="nc" id="L132">        UpdateRule newUpdateRule = ruleFactory.createUpdateRule();</span>
<span class="nc" id="L133">       	Term leftHandSide = updateRule.getLocation();</span>
<span class="nc" id="L134">        Term newLeftHandSide = visit(leftHandSide);</span>
<span class="nc bnc" id="L135" title="All 4 branches missed.">        if (newLeftHandSide instanceof LocationTerm || newLeftHandSide instanceof VariableTerm) {</span>
<span class="nc" id="L136">            newUpdateRule.setLocation(newLeftHandSide);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        } else if (newLeftHandSide instanceof FunctionTerm) {</span>
        	// converts a FunctionTerm to a LocationTerm
<span class="nc" id="L139">            LocationTerm locationTerm = createLocationTerm((FunctionTerm) newLeftHandSide);</span>
<span class="nc" id="L140">            newUpdateRule.setLocation(locationTerm);</span>
<span class="nc" id="L141">        } else {</span>
<span class="nc" id="L142">            throw new Error(&quot;Expected a location term or a location variable, but found &quot; + newLeftHandSide.getClass().getName());</span>
        }
<span class="nc" id="L144">        logger.debug(&quot;&lt;/Location&gt;&quot;);</span>
<span class="nc" id="L145">        logger.debug(&quot;&lt;UpdatingTerm&gt;&quot;);</span>
<span class="nc" id="L146">        Term updatingTerm = updateRule.getUpdatingTerm();</span>
<span class="nc" id="L147">        Term newRightHandSide = visit(updatingTerm);</span>
<span class="nc" id="L148">        newUpdateRule.setUpdatingTerm(newRightHandSide);</span>
<span class="nc" id="L149">        logger.debug(&quot;&lt;/UpdatingTerm&gt;&quot;);</span>
<span class="nc" id="L150">    	logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(updateRule) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L151">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newUpdateRule) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L152">        logger.debug(&quot;&lt;/UpdateRule&gt;&quot;);</span>
<span class="nc" id="L153">        return newUpdateRule;</span>
    }

    /**
     * Converts a dynamic function term to a location term.
     *
     * @param functionTerm a function
     * @return the location
     */
    private LocationTerm createLocationTerm(FunctionTerm functionTerm) {
    	// IMPORTANT
    	// You must create a new tuple term in order to pass the arguments of
    	// the function term to the location term.
    	// If you simply use code like this:
    	// locationTerm.setArguments(functionTerm.getArguments());
    	// you get a javax.jmi.reflect.CompositionViolationException.
    	// I don't know if it is a bug or what.
    	// SUPPLEMENT: It isn't a bug. For each sub-element, which has a
    	// composition relationship with his main element (solid diamond), one
    	// needs to create a new object.
<span class="nc" id="L173">    	LocationTerm locationTerm = ruleFactory.createLocationTerm();</span>
<span class="nc" id="L174">    	TupleTerm arguments = functionTerm.getArguments();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">		if (arguments != null) {</span>
<span class="nc" id="L176">    		TupleTerm tupleTerm = ruleFactory.createTupleTerm();</span>
<span class="nc" id="L177">    		tupleTerm.setArity(arguments.getArity());</span>
    		//assert arguments.getTerms() == null || arguments.getArity() == arguments.getTerms().size();
<span class="nc" id="L179">    		tupleTerm.getTerms().addAll(arguments.getTerms());</span>
<span class="nc" id="L180">    		tupleTerm.setDomain(arguments.getDomain());</span>
<span class="nc" id="L181">    		tupleTerm.setArity(arguments.getArity());</span>
<span class="nc" id="L182">    		locationTerm.setArguments(tupleTerm);</span>
    	}
<span class="nc" id="L184">    	locationTerm.setFunction(functionTerm.getFunction());</span>
<span class="nc" id="L185">    	locationTerm.setDomain(functionTerm.getDomain());</span>
<span class="nc" id="L186">    	return locationTerm;</span>
    }

	/**
	 * Does substitutions on the block rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public BlockRule visit(BlockRule blockRule) {
<span class="nc" id="L196">    	logger.debug(&quot;&lt;BlockRule&gt;&quot;);</span>
<span class="nc" id="L197">        BlockRule newBlockRule = ruleFactory.createBlockRule();</span>
<span class="nc" id="L198">        logger.debug(&quot;&lt;RuleList&gt;&quot;);</span>
<span class="nc" id="L199">        List&lt;Rule&gt; newRuleList = new ArrayList&lt;Rule&gt;();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">        for (Rule rule : blockRule.getRules()) {</span>
<span class="nc" id="L201">            Rule newRule = visit(rule);</span>
<span class="nc" id="L202">            newRuleList.add(newRule);</span>
<span class="nc" id="L203">        }</span>
<span class="nc" id="L204">        newBlockRule.getRules().addAll(newRuleList);</span>
<span class="nc" id="L205">        logger.debug(&quot;&lt;/RuleList&gt;&quot;);</span>
<span class="nc" id="L206">        logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(blockRule) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L207">        logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newBlockRule) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L208">        logger.debug(&quot;&lt;/BlockRule&gt;&quot;);</span>
<span class="nc" id="L209">        return newBlockRule;</span>
    }

	/**
	 * Does substitutions on the sequential rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public SeqRule visit(SeqRule seqRule) {
<span class="nc" id="L219">    	logger.debug(&quot;&lt;SeqRule&gt;&quot;);</span>
<span class="nc" id="L220">        SeqRule newSeqRule = ruleFactory.createSeqRule();</span>
<span class="nc" id="L221">        List&lt;Rule&gt; newRuleList = new ArrayList&lt;Rule&gt;();</span>
<span class="nc" id="L222">        logger.debug(&quot;&lt;RuleList&gt;&quot;);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        for (Rule rule : seqRule.getRules()) {</span>
<span class="nc" id="L224">            Rule newRule = visit(rule);</span>
<span class="nc" id="L225">            newRuleList.add(newRule);</span>
<span class="nc" id="L226">        }</span>
<span class="nc" id="L227">        newSeqRule.getRules().addAll(newRuleList);</span>
<span class="nc" id="L228">        logger.debug(&quot;&lt;/RuleList&gt;&quot;);</span>
<span class="nc" id="L229">    	logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(seqRule) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L230">        logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newSeqRule) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L231">        logger.debug(&quot;&lt;/SeqRule&gt;&quot;);</span>
<span class="nc" id="L232">        return newSeqRule;</span>
    }

	/**
	 * Does substitutions on the term as rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public Rule visit(TermAsRule termAsRule) {
<span class="nc" id="L242">    	TermAsRule newTermAsRule = ruleFactory.createTermAsRule();</span>
<span class="nc" id="L243">    	logger.debug(&quot;&lt;TermAsRule&gt;&quot;);</span>
<span class="nc" id="L244">    	Term newTerm = visit(termAsRule.getTerm());    	</span>
<span class="nc" id="L245">    	List&lt;Term&gt; args = termAsRule.getParameters();</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">    	if (args != null &amp;&amp; args.size() &gt; 0) {</span>
<span class="nc" id="L247">    		logger.debug(&quot;&lt;Arguments&gt;&quot;);</span>
<span class="nc" id="L248">    		List&lt;Term&gt; newArgs = visit(args);</span>
<span class="nc" id="L249">    		logger.debug(&quot;&lt;/Arguments&gt;&quot;);</span>
<span class="nc" id="L250">    		newTermAsRule.getParameters().addAll(newArgs);</span>
    	}
<span class="nc" id="L252">    	newTermAsRule.setTerm(newTerm);    	    	    </span>
<span class="nc" id="L253">    	logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(termAsRule) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L254">        logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newTermAsRule) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L255">        logger.debug(&quot;&lt;/TermAsRule&gt;&quot;);</span>
<span class="nc" id="L256">        return newTermAsRule;</span>
    }

	/**
	 * Does substitutions on the conditional rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public ConditionalRule visit(ConditionalRule condRule) {
<span class="nc" id="L266">    	logger.debug(&quot;&lt;ConditionalRule&gt;&quot;);</span>
<span class="nc" id="L267">        ConditionalRule newCondRule = ruleFactory.createConditionalRule();</span>
<span class="nc" id="L268">        logger.debug(&quot;&lt;Guard&gt;&quot;);</span>
<span class="nc" id="L269">        Term guard = visit(condRule.getGuard());</span>
<span class="nc" id="L270">        logger.debug(&quot;&lt;/Guard&gt;&quot;);</span>
<span class="nc" id="L271">        logger.debug(&quot;&lt;ThenRule&gt;&quot;);</span>
<span class="nc" id="L272">        Rule thenRule = visit(condRule.getThenRule());</span>
<span class="nc" id="L273">        logger.debug(&quot;&lt;/ThenRule&gt;&quot;);</span>
<span class="nc" id="L274">        Rule elseRule = null;</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (condRule.getElseRule() != null) {</span>
<span class="nc" id="L276">        	logger.debug(&quot;&lt;ElseRule&gt;&quot;);</span>
<span class="nc" id="L277">            elseRule = visit(condRule.getElseRule());</span>
<span class="nc" id="L278">            logger.debug(&quot;&lt;/ElseRule&gt;&quot;);</span>
        }
<span class="nc" id="L280">        newCondRule.setGuard(guard);</span>
<span class="nc" id="L281">        newCondRule.setThenRule(thenRule);</span>
<span class="nc" id="L282">        newCondRule.setElseRule(elseRule);</span>
<span class="nc" id="L283">    	logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(condRule) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L284">        logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newCondRule) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L285">        logger.debug(&quot;&lt;/ConditionalRule&gt;&quot;);</span>
<span class="nc" id="L286">        return newCondRule;</span>
    }

	/**
	 * Does substitutions on the switch rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
	public CaseRule visit(CaseRule caseRule) {
<span class="nc" id="L296">		logger.debug(&quot;&lt;CaseRule&gt;&quot;);</span>
<span class="nc" id="L297">		CaseRule newCase = ruleFactory.createCaseRule();</span>
<span class="nc" id="L298">		logger.debug(&quot;&lt;ComparedTerm&gt;&quot;);</span>
<span class="nc" id="L299">		Term newComparedTerm = visit(caseRule.getTerm());</span>
<span class="nc" id="L300">		newCase.setTerm(newComparedTerm);</span>
<span class="nc" id="L301">		logger.debug(&quot;&lt;/ComparedTerm&gt;&quot;);</span>
<span class="nc" id="L302">		logger.debug(&quot;&lt;ComparingTerms&gt;&quot;);</span>
<span class="nc" id="L303">		List&lt;Term&gt; newComparingTerms = newCase.getCaseTerm();</span>
<span class="nc" id="L304">		visit(caseRule.getCaseTerm(), newComparingTerms);</span>
<span class="nc" id="L305">		logger.debug(&quot;&lt;/ComparingTerms&gt;&quot;);</span>
<span class="nc" id="L306">		logger.debug(&quot;&lt;BranchRules&gt;&quot;);</span>
<span class="nc" id="L307">		List&lt;Rule&gt; newBranchRules = visitRules(caseRule.getCaseBranches());</span>
<span class="nc" id="L308">		newCase.getCaseBranches().addAll(newBranchRules);</span>
<span class="nc" id="L309">		logger.debug(&quot;&lt;/BranchRules&gt;&quot;);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">		if (caseRule.getOtherwiseBranch() != null) {</span>
<span class="nc" id="L311">			logger.debug(&quot;&lt;OtherwiseRule&gt;&quot;);</span>
<span class="nc" id="L312">			Rule newOtherwise = visit(caseRule.getOtherwiseBranch());</span>
<span class="nc" id="L313">			newCase.setOtherwiseBranch(newOtherwise);</span>
<span class="nc" id="L314">			logger.debug(&quot;&lt;/OtherwiseRule&gt;&quot;);</span>
		}
<span class="nc" id="L316">		logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(caseRule) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L317">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newCase) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L318">		logger.debug(&quot;&lt;/CaseRule&gt;&quot;);</span>
<span class="nc" id="L319">		return newCase;</span>
	}

	/**
	 * Does substitutions on the let rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public LetRule visit(LetRule let) {
<span class="nc" id="L329">		logger.debug(&quot;&lt;LetRule&gt;&quot;);</span>
<span class="nc" id="L330">		LetRule newLet = ruleFactory.createLetRule();</span>
<span class="nc" id="L331">		RuleSubstitution newSubstitution = new RuleSubstitution(this);</span>
<span class="nc" id="L332">		logger.debug(&quot;&lt;Variables&gt;&quot;);</span>
<span class="nc" id="L333">		List&lt;VariableTerm&gt; newVarList = newLet.getVariable();</span>
<span class="nc" id="L334">		newSubstitution.visitBoundVars(let.getVariable(), newVarList);</span>
<span class="nc" id="L335">		logger.debug(&quot;&lt;/Variables&gt;&quot;);</span>
<span class="nc" id="L336">		logger.debug(&quot;&lt;InitTerms&gt;&quot;);</span>
<span class="nc" id="L337">		List&lt;Term&gt; newInitList = newLet.getInitExpression();</span>
<span class="nc" id="L338">		newSubstitution.visit(let.getInitExpression(), newInitList);</span>
<span class="nc" id="L339">		logger.debug(&quot;&lt;/InitTerms&gt;&quot;);</span>
<span class="nc" id="L340">		logger.debug(&quot;&lt;InRule&gt;&quot;);</span>
<span class="nc" id="L341">		Rule newInRule = newSubstitution.visit(let.getInRule());</span>
<span class="nc" id="L342">		newLet.setInRule(newInRule);</span>
<span class="nc" id="L343">		logger.debug(&quot;&lt;/InRule&gt;&quot;);</span>
<span class="nc" id="L344">		logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(let) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L345">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newLet) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L346">		logger.debug(&quot;&lt;/LetRule&gt;&quot;);</span>
<span class="nc" id="L347">		return newLet;</span>
	}

	/**
	 * Does substitutions on the forall rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
	public ForallRule visit(ForallRule forall) {
<span class="nc" id="L357">		logger.debug(&quot;&lt;ForallRule&gt;&quot;);</span>
<span class="nc" id="L358">		ForallRule newForall = ruleFactory.createForallRule();</span>
<span class="nc" id="L359">		RuleSubstitution newSubstitution = new RuleSubstitution(this);</span>
<span class="nc" id="L360">		logger.debug(&quot;&lt;Variables&gt;&quot;);</span>
<span class="nc" id="L361">		List&lt;VariableTerm&gt; newVarList = newForall.getVariable();</span>
<span class="nc" id="L362">		newSubstitution.visitBoundVars(forall.getVariable(), newVarList);</span>
<span class="nc" id="L363">		logger.debug(&quot;&lt;/Variables&gt;&quot;);</span>
<span class="nc" id="L364">		logger.debug(&quot;&lt;Ranges&gt;&quot;);</span>
<span class="nc" id="L365">		List&lt;Term&gt; newRanges = newSubstitution.visit(forall.getRanges());</span>
<span class="nc" id="L366">		newForall.getRanges().addAll(newRanges);</span>
<span class="nc" id="L367">		logger.debug(&quot;&lt;/Ranges&gt;&quot;);</span>
<span class="nc" id="L368">		logger.debug(&quot;&lt;Guard&gt;&quot;);</span>
<span class="nc" id="L369">		Term newGuard = newSubstitution.visit(forall.getGuard());</span>
<span class="nc" id="L370">		newForall.setGuard(newGuard);</span>
<span class="nc" id="L371">		logger.debug(&quot;&lt;/Guard&gt;&quot;);</span>
<span class="nc" id="L372">		logger.debug(&quot;&lt;DoRule&gt;&quot;);</span>
<span class="nc" id="L373">		Rule newDoRule = newSubstitution.visit(forall.getDoRule());</span>
<span class="nc" id="L374">		newForall.setDoRule(newDoRule);</span>
<span class="nc" id="L375">		logger.debug(&quot;&lt;/DoRule&gt;&quot;);</span>
<span class="nc" id="L376">    	logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(forall) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L377">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newForall) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L378">    	logger.debug(&quot;&lt;/ForallRule&gt;&quot;);</span>
<span class="nc" id="L379">		return newForall;</span>
	}

	/**
	 * Does substitutions on the choose rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
	public ChooseRule visit(ChooseRule choose) {
<span class="nc" id="L389">		logger.debug(&quot;&lt;ChooseRule&gt;&quot;);</span>
<span class="nc" id="L390">		ChooseRule newChoose = ruleFactory.createChooseRule();</span>
<span class="nc" id="L391">		RuleSubstitution newSubstitution = new RuleSubstitution(this);</span>
<span class="nc" id="L392">		logger.debug(&quot;&lt;Variables&gt;&quot;);</span>
<span class="nc" id="L393">		List&lt;VariableTerm&gt; newVarList = newChoose.getVariable();</span>
<span class="nc" id="L394">		newSubstitution.visitBoundVars(choose.getVariable(), newVarList);</span>
<span class="nc" id="L395">		logger.debug(&quot;&lt;/Variables&gt;&quot;);</span>
<span class="nc" id="L396">		logger.debug(&quot;&lt;Ranges&gt;&quot;);</span>
<span class="nc" id="L397">		List&lt;Term&gt; newRanges = newSubstitution.visit(choose.getRanges());</span>
<span class="nc" id="L398">		newChoose.getRanges().addAll(newRanges);</span>
<span class="nc" id="L399">		logger.debug(&quot;&lt;/Ranges&gt;&quot;);</span>
<span class="nc" id="L400">		logger.debug(&quot;&lt;Guard&gt;&quot;);</span>
<span class="nc" id="L401">		Term newGuard = newSubstitution.visit(choose.getGuard());</span>
<span class="nc" id="L402">		newChoose.setGuard(newGuard);</span>
<span class="nc" id="L403">		logger.debug(&quot;&lt;/Guard&gt;&quot;);</span>
<span class="nc" id="L404">		logger.debug(&quot;&lt;DoRule&gt;&quot;);</span>
<span class="nc" id="L405">		Rule newDoRule = newSubstitution.visit(choose.getDoRule());</span>
<span class="nc" id="L406">		newChoose.setDoRule(newDoRule);</span>
<span class="nc" id="L407">		logger.debug(&quot;&lt;/DoRule&gt;&quot;);</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">		if (choose.getIfnone() != null) {</span>
<span class="nc" id="L409">			logger.debug(&quot;&lt;IfnoneRule&gt;&quot;);</span>
<span class="nc" id="L410">			Rule newIfnone = newSubstitution.visit(choose.getIfnone());</span>
<span class="nc" id="L411">			newChoose.setIfnone(newIfnone);</span>
<span class="nc" id="L412">			logger.debug(&quot;&lt;/IfnoneRule&gt;&quot;);</span>
		}
<span class="nc" id="L414">    	logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(choose) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L415">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newChoose) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L416">    	logger.debug(&quot;&lt;/ChooseRule&gt;&quot;);</span>
<span class="nc" id="L417">		return newChoose;</span>
	}

	/**
	 * Does substitutions on the choose rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
	public IterativeWhileRule visit(IterativeWhileRule itWhileRule) {
<span class="nc" id="L427">		logger.debug(&quot;&lt;IterativeWhileRule&gt;&quot;);</span>
<span class="nc" id="L428">		IterativeWhileRule newItWhileRule = ruleFactory.createIterativeWhileRule();</span>
<span class="nc" id="L429">		RuleSubstitution newSubstitution = new RuleSubstitution(this);</span>
<span class="nc" id="L430">		logger.debug(&quot;&lt;Guard&gt;&quot;);</span>
<span class="nc" id="L431">		Term newGuard = newSubstitution.visit(itWhileRule.getGuard());</span>
<span class="nc" id="L432">		newItWhileRule.setGuard(newGuard);</span>
<span class="nc" id="L433">		logger.debug(&quot;&lt;/Guard&gt;&quot;);</span>
<span class="nc" id="L434">		logger.debug(&quot;&lt;Rule&gt;&quot;);</span>
<span class="nc" id="L435">		Rule newRule = newSubstitution.visit(itWhileRule.getRule());</span>
<span class="nc" id="L436">		newItWhileRule.setRule(newRule);</span>
<span class="nc" id="L437">		logger.debug(&quot;&lt;/Rule&gt;&quot;);</span>
<span class="nc" id="L438">		logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(itWhileRule) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L439">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newItWhileRule) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L440">    	logger.debug(&quot;&lt;/IterativeWhileRule&gt;&quot;);</span>
<span class="nc" id="L441">		return newItWhileRule;</span>
	}

	/**
	 * Does substitutions on the macro call rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public MacroCallRule visit(MacroCallRule macro) {
<span class="nc" id="L451">    	logger.debug(&quot;&lt;MacroCallRule&gt;&quot;);</span>
<span class="nc" id="L452">    	MacroCallRule newMacro = ruleFactory.createMacroCallRule();</span>
<span class="nc" id="L453">    	logger.debug(&quot;&lt;Arguments&gt;&quot;);</span>
<span class="nc" id="L454">    	List&lt;Term&gt; newParams = visit(macro.getParameters());</span>
<span class="nc" id="L455">    	newMacro.getParameters().addAll(newParams);</span>
<span class="nc" id="L456">    	logger.debug(&quot;&lt;/Arguments&gt;&quot;);</span>
<span class="nc" id="L457">    	newMacro.setCalledMacro(macro.getCalledMacro());</span>
<span class="nc" id="L458">		logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(macro) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L459">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newMacro) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L460">    	logger.debug(&quot;&lt;/MacroCallRule&gt;&quot;);</span>
<span class="nc" id="L461">    	return newMacro;</span>
    }
    
	/**
	 * Does substitutions on the turbo call rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
    public TurboCallRule visit(TurboCallRule turbo) {
<span class="nc" id="L471">    	logger.debug(&quot;&lt;TurboCallRule&gt;&quot;);</span>
<span class="nc" id="L472">    	TurboCallRule newTurbo = ruleFactory.createTurboCallRule();</span>
<span class="nc" id="L473">    	logger.debug(&quot;&lt;Arguments&gt;&quot;);</span>
<span class="nc" id="L474">    	List&lt;Term&gt; newParams = visit(turbo.getParameters());</span>
<span class="nc" id="L475">    	newTurbo.getParameters().addAll(newParams);</span>
<span class="nc" id="L476">    	logger.debug(&quot;&lt;/Arguments&gt;&quot;);</span>
<span class="nc" id="L477">    	newTurbo.setCalledRule(turbo.getCalledRule());</span>
<span class="nc" id="L478">		logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(turbo) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L479">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newTurbo) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L480">    	logger.debug(&quot;&lt;/TurboCallRule&gt;&quot;);</span>
<span class="nc" id="L481">    	return newTurbo;</span>
    }
    
    public TurboReturnRule visit(TurboReturnRule retRule) {
<span class="nc" id="L485">    	TurboReturnRule newRetRule = ruleFactory.createTurboReturnRule();</span>
<span class="nc" id="L486">    	newRetRule.setLocation(retRule.getLocation());</span>
<span class="nc" id="L487">    	newRetRule.setUpdateRule(retRule.getUpdateRule());</span>
<span class="nc" id="L488">    	return newRetRule;</span>
    }

	/**
	 * Does substitutions on the extend rule.
	 * 
	 * @param rule a rule
	 * @return the new rule
	 */
	public ExtendRule visit(ExtendRule extend) {
<span class="nc" id="L498">		logger.debug(&quot;&lt;ExtendRule&gt;&quot;);</span>
<span class="nc" id="L499">		ExtendRule newExtend = ruleFactory.createExtendRule();</span>
<span class="nc" id="L500">		RuleSubstitution newSubstitution = new RuleSubstitution(this);</span>
<span class="nc" id="L501">		logger.debug(&quot;&lt;Variables&gt;&quot;);</span>
<span class="nc" id="L502">		Collection&lt;VariableTerm&gt; newVarList = newExtend.getBoundVar();</span>
<span class="nc" id="L503">		newSubstitution.visitBoundVars(extend.getBoundVar(), newVarList);</span>
<span class="nc" id="L504">		logger.debug(&quot;&lt;/Variables&gt;&quot;);</span>
<span class="nc" id="L505">		newExtend.setExtendedDomain(extend.getExtendedDomain());</span>
<span class="nc" id="L506">		logger.debug(&quot;&lt;DoRule&gt;&quot;);</span>
<span class="nc" id="L507">		Rule newDoRule = newSubstitution.visit(extend.getDoRule());</span>
<span class="nc" id="L508">		newExtend.setDoRule(newDoRule);</span>
<span class="nc" id="L509">		logger.debug(&quot;&lt;/DoRule&gt;&quot;);</span>
<span class="nc" id="L510">		logger.debug(&quot;&lt;Before&gt;&quot; + printer.visit(extend) + &quot;&lt;/Before&gt;&quot;);</span>
<span class="nc" id="L511">    	logger.debug(&quot;&lt;After&gt;&quot; + printer.visit(newExtend) + &quot;&lt;/After&gt;&quot;);</span>
<span class="nc" id="L512">		logger.debug(&quot;&lt;/ExtendRule&gt;&quot;);</span>
<span class="nc" id="L513">		return newExtend;</span>
	}

	/**
	 * Does substitutions on a list of rules.
	 * 
	 * @param ruleList a list of rules
	 * @return the list of new rules
	 */
    protected List&lt;Rule&gt; visitRules(Collection&lt;Rule&gt; ruleList) {
<span class="nc" id="L523">    	ArrayList&lt;Rule&gt; newList = new ArrayList&lt;Rule&gt;();</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">    	for (Rule rule : ruleList) {</span>
<span class="nc" id="L525">			Rule newRule = visit(rule);</span>
<span class="nc" id="L526">			newList.add(newRule);</span>
<span class="nc" id="L527">		}</span>
<span class="nc" id="L528">    	return newList;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>