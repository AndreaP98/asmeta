<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RuleSimplifier.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">report.aggregate</a> &gt; <a href="../index.html" class="el_bundle">asmeta.flattener</a> &gt; <a href="index.source.html" class="el_package">org.asmeta.flattener.rule</a> &gt; <span class="el_source">RuleSimplifier.java</span></div><h1>RuleSimplifier.java</h1><pre class="source lang-java linenums">package org.asmeta.flattener.rule;

import java.util.ArrayList;
import java.util.List;

import org.apache.log4j.Logger;
import org.asmeta.flattener.statistics.Statistics;
import org.asmeta.flattener.term.DomainVisitor;
import org.asmeta.flattener.term.TermSimplifier;
import org.asmeta.flattener.util.StdlFunction;
import org.asmeta.parser.util.ReflectiveVisitor;
import org.asmeta.simulator.wrapper.RuleFactory;
import asmeta.definitions.RuleDeclaration;
import asmeta.structure.Asm;
import asmeta.terms.basicterms.Term;
import asmeta.transitionrules.basictransitionrules.BlockRule;
import asmeta.transitionrules.basictransitionrules.ChooseRule;
import asmeta.transitionrules.basictransitionrules.ConditionalRule;
import asmeta.transitionrules.basictransitionrules.ExtendRule;
import asmeta.transitionrules.basictransitionrules.ForallRule;
import asmeta.transitionrules.basictransitionrules.LetRule;
import asmeta.transitionrules.basictransitionrules.MacroCallRule;
import asmeta.transitionrules.basictransitionrules.Rule;
import asmeta.transitionrules.basictransitionrules.SkipRule;
import asmeta.transitionrules.basictransitionrules.TermAsRule;
import asmeta.transitionrules.basictransitionrules.UpdateRule;
import asmeta.transitionrules.derivedtransitionrules.CaseRule;
import asmeta.transitionrules.turbotransitionrules.SeqRule;

<span class="pc bpc" id="L30" title="1 of 2 branches missed.">public class RuleSimplifier extends ReflectiveVisitor&lt;Rule&gt; implements AsmetaFlattener {</span>
<span class="fc" id="L31">	static final Logger logger = Logger.getLogger(RuleSimplifier.class);</span>

	private TermSimplifier ts;
	private Asm asm;
	private RuleFactory ruleFact;

<span class="fc" id="L37">	public RuleSimplifier(Asm asm) {</span>
<span class="fc" id="L38">		this.asm = asm;</span>
<span class="fc" id="L39">		DomainVisitor dv = new DomainVisitor(asm);</span>
<span class="fc" id="L40">		dv.visitDomains();</span>
<span class="fc" id="L41">		StdlFunction sl = new StdlFunction(asm);</span>
<span class="fc" id="L42">		ts = new TermSimplifier(dv, sl);</span>
<span class="fc" id="L43">		ruleFact = new RuleFactory();</span>
<span class="fc" id="L44">	}</span>

	@Override
	public Asm flattenASM() {
<span class="fc" id="L48">		List&lt;RuleDeclaration&gt; rules = asm.getBodySection().getRuleDeclaration();</span>
<span class="fc bfc" id="L49" title="All 2 branches covered.">		for (RuleDeclaration r : rules) {</span>
<span class="fc" id="L50">			r.setRuleBody(visit(r.getRuleBody()));</span>
<span class="fc" id="L51">		}</span>
<span class="fc" id="L52">		return asm;</span>
	}

	private List&lt;Rule&gt; simplifyRules(List&lt;Rule&gt; rules) {
<span class="fc" id="L56">		List&lt;Rule&gt; newRules = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">		for (Rule rule : rules) {</span>
<span class="fc" id="L58">			Rule newRule = visit(rule);</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">			if (!(newRule instanceof SkipRule)) {</span>
<span class="fc" id="L60">				newRules.add(newRule);</span>
			}
<span class="fc" id="L62">		}</span>
<span class="fc" id="L63">		return newRules;</span>
	}

	public Rule visit(TermAsRule termAsRule) {
<span class="fc" id="L67">		TermAsRule newTermAsRule = ruleFact.createTermAsRule();</span>
<span class="fc" id="L68">		newTermAsRule.setTerm(ts.visit(termAsRule.getTerm()));</span>
<span class="fc" id="L69">		List&lt;Term&gt; oldParams = termAsRule.getParameters();</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">		for(Term p: oldParams) {</span>
<span class="nc" id="L71">			newTermAsRule.getParameters().add(ts.visit(p));</span>
<span class="nc" id="L72">		}</span>
		//System.out.println(newTermAsRule.getTerm());
<span class="fc" id="L74">		return newTermAsRule;</span>
	}

	public Rule visit(BlockRule blockRule) {
<span class="fc" id="L78">		List&lt;Rule&gt; newRules = simplifyRules(blockRule.getRules());</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">		if (newRules.size() == 0) {</span>
<span class="nc" id="L80">			logger.debug(&quot;block rule simplified&quot;);</span>
			// Statistics.getInstance().increaseValue(this.getCode());
<span class="nc" id="L82">			return ruleFact.createSkipRule();</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">		} else if (newRules.size() == 1) {</span>
<span class="fc" id="L84">			logger.debug(&quot;block rule simplified&quot;);</span>
			// Statistics.getInstance().increaseValue(this.getCode());
<span class="fc" id="L86">			return newRules.get(0);</span>
		} else {
<span class="fc" id="L88">			BlockRule newBlockRule = ruleFact.createBlockRule();</span>
<span class="fc" id="L89">			newBlockRule.getRules().addAll(newRules);</span>
<span class="fc" id="L90">			return newBlockRule;</span>
		}
	}

	public Rule visit(SeqRule seqRule) {
<span class="nc" id="L95">		List&lt;Rule&gt; newRules = simplifyRules(seqRule.getRules());</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">		if (newRules.size() == 0) {</span>
<span class="nc" id="L97">			logger.debug(&quot;seq rule simplified&quot;);</span>
<span class="nc" id="L98">			Statistics.getInstance().increaseValue(this.getCode());</span>
<span class="nc" id="L99">			return ruleFact.createSkipRule();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">		} else if (newRules.size() == 1) {</span>
<span class="nc" id="L101">			logger.debug(&quot;seq rule simplified&quot;);</span>
<span class="nc" id="L102">			Statistics.getInstance().increaseValue(this.getCode());</span>
<span class="nc" id="L103">			return newRules.get(0);</span>
		} else {
<span class="nc" id="L105">			SeqRule newSeqRule = ruleFact.createSeqRule();</span>
<span class="nc" id="L106">			newSeqRule.getRules().addAll(newRules);</span>
<span class="nc" id="L107">			return newSeqRule;</span>
		}
	}

	public Rule visit(ConditionalRule condRule) {
<span class="fc" id="L112">		Term newGuard = ts.visit(condRule.getGuard());</span>
<span class="pc bpc" id="L113" title="2 of 4 branches missed.">		assert condRule.getThenRule() != null;</span>
<span class="fc" id="L114">		Rule newThenRule = visit(condRule.getThenRule());</span>
<span class="fc" id="L115">		Rule newElseRule = null;</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">		if (condRule.getElseRule() != null) {</span>
<span class="fc" id="L117">			newElseRule = visit(condRule.getElseRule());</span>
		}
<span class="fc bfc" id="L119" title="All 2 branches covered.">		if (newGuard.equals(TermSimplifier.trueT)) {</span>
<span class="fc" id="L120">			logger.debug(&quot;conditional rule simplified&quot;);</span>
<span class="fc" id="L121">			Statistics.getInstance().increaseValue(this.getCode());</span>
<span class="fc" id="L122">			return newThenRule;</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">		} else if (newGuard.equals(TermSimplifier.falseT)) {</span>
<span class="fc" id="L124">			logger.debug(&quot;conditional rule simplified&quot;);</span>
<span class="fc" id="L125">			Statistics.getInstance().increaseValue(this.getCode());</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">			if (newElseRule != null) {</span>
<span class="nc" id="L127">				return newElseRule;</span>
			} else {
<span class="fc" id="L129">				return ruleFact.createSkipRule();</span>
			}
		}
<span class="fc" id="L132">		ConditionalRule newCondRule = ruleFact.createConditionalRule();</span>
<span class="fc" id="L133">		newCondRule.setGuard(newGuard);</span>
<span class="pc bpc" id="L134" title="2 of 4 branches missed.">		assert newThenRule != null;</span>
<span class="fc" id="L135">		newCondRule.setThenRule(newThenRule);</span>
<span class="fc" id="L136">		newCondRule.setElseRule(newElseRule);</span>
<span class="fc" id="L137">		return newCondRule;</span>
	}

	public Rule visit(UpdateRule updateRule) {
<span class="fc" id="L141">		UpdateRule newUpdateRule = ruleFact.createUpdateRule();</span>
<span class="fc" id="L142">		newUpdateRule.setLocation(ts.visit(updateRule.getLocation()));</span>
<span class="fc" id="L143">		newUpdateRule.setUpdatingTerm(ts.visit(updateRule.getUpdatingTerm()));</span>
<span class="fc" id="L144">		return newUpdateRule;</span>
	}

	public Rule visit(ChooseRule chooseRule) {
<span class="fc" id="L148">		Term newGuard = ts.visit(chooseRule.getGuard());</span>
<span class="fc" id="L149">		Rule newOther = null;</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">		if (chooseRule.getIfnone() != null) {</span>
<span class="fc" id="L151">			newOther = visit(chooseRule.getIfnone());</span>
		}
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">		if (newGuard.equals(TermSimplifier.falseT)) {</span>
<span class="nc" id="L154">			logger.debug(&quot;choose rule simplified&quot;);</span>
<span class="nc" id="L155">			Statistics.getInstance().increaseValue(this.getCode());</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">			if (newOther != null) {</span>
<span class="nc" id="L157">				return newOther;</span>
			} else {
<span class="nc" id="L159">				return ruleFact.createSkipRule();</span>
			}
		}
<span class="fc" id="L162">		ChooseRule newChooseRule = ruleFact.createChooseRule();</span>
<span class="fc" id="L163">		newChooseRule.getVariable().addAll(chooseRule.getVariable());</span>
<span class="fc" id="L164">		newChooseRule.getRanges().addAll(chooseRule.getRanges());</span>
<span class="fc" id="L165">		newChooseRule.setGuard(newGuard);</span>
<span class="fc" id="L166">		newChooseRule.setDoRule(visit(chooseRule.getDoRule()));</span>
		;
<span class="fc" id="L168">		newChooseRule.setIfnone(newOther);</span>
<span class="fc" id="L169">		return newChooseRule;</span>
	}

	public Rule visit(ForallRule forallRule) {
<span class="fc" id="L173">		Term newGuard = ts.visit(forallRule.getGuard());</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">		if (newGuard.equals(TermSimplifier.falseT)) {</span>
<span class="nc" id="L175">			logger.debug(&quot;forall rule simplified&quot;);</span>
<span class="nc" id="L176">			Statistics.getInstance().increaseValue(this.getCode());</span>
<span class="nc" id="L177">			return ruleFact.createSkipRule();</span>
		}
<span class="fc" id="L179">		ForallRule newForallRule = ruleFact.createForallRule();</span>
<span class="fc" id="L180">		newForallRule.getVariable().addAll(forallRule.getVariable());</span>
<span class="fc" id="L181">		newForallRule.getRanges().addAll(forallRule.getRanges());</span>
<span class="fc" id="L182">		newForallRule.setGuard(newGuard);</span>
<span class="fc" id="L183">		newForallRule.setDoRule(visit(forallRule.getDoRule()));</span>
		;
<span class="fc" id="L185">		return newForallRule;</span>
	}

	public Rule visit(SkipRule skipRule) {
<span class="fc" id="L189">		return skipRule;</span>
	}

	public Rule visit(CaseRule caseRule) {
<span class="fc" id="L193">		CaseRule newCaseRule = ruleFact.createCaseRule();</span>
<span class="fc" id="L194">		newCaseRule.setTerm(ts.visit(caseRule.getTerm()));</span>
<span class="fc" id="L195">		List&lt;Term&gt; caseTerm = caseRule.getCaseTerm();</span>
<span class="fc" id="L196">		List&lt;Rule&gt; caseBranches = caseRule.getCaseBranches();</span>
<span class="fc" id="L197">		List&lt;Term&gt; newCaseTerm = new ArrayList&lt;Term&gt;();</span>
<span class="fc" id="L198">		List&lt;Rule&gt; newCaseBranches = new ArrayList&lt;Rule&gt;();</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">		for (int i = 0; i &lt; caseTerm.size(); i++) {</span>
<span class="fc" id="L200">			newCaseTerm.add(ts.visit(caseTerm.get(i)));</span>
<span class="fc" id="L201">			newCaseBranches.add(visit(caseBranches.get(i)));</span>
		}
<span class="fc" id="L203">		newCaseRule.getCaseTerm().addAll(newCaseTerm);</span>
<span class="fc" id="L204">		newCaseRule.getCaseBranches().addAll(newCaseBranches);</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">		if (caseRule.getOtherwiseBranch() != null) {</span>
<span class="fc" id="L206">			newCaseRule.setOtherwiseBranch(visit(caseRule.getOtherwiseBranch()));</span>
		}
<span class="fc" id="L208">		return newCaseRule;</span>
	}

	public Rule visit(MacroCallRule macroCallRule) {
<span class="fc" id="L212">		MacroCallRule newMacroCallRule = ruleFact.createMacroCallRule();</span>
<span class="fc" id="L213">		newMacroCallRule.setCalledMacro(macroCallRule.getCalledMacro());</span>
<span class="fc" id="L214">		List&lt;Term&gt; newParameters = new ArrayList&lt;Term&gt;();</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">		for (Term p : macroCallRule.getParameters()) {</span>
<span class="fc" id="L216">			newParameters.add(ts.visit(p));</span>
<span class="fc" id="L217">		}</span>
<span class="fc" id="L218">		newMacroCallRule.getParameters().addAll(newParameters);</span>
<span class="fc" id="L219">		return newMacroCallRule;</span>
	}

	public Rule visit(LetRule letRule) {
<span class="fc" id="L223">		LetRule newLetRule = ruleFact.createLetRule();</span>
<span class="fc" id="L224">		newLetRule.getVariable().addAll(letRule.getVariable());</span>
<span class="fc" id="L225">		List&lt;Term&gt; initExp = letRule.getInitExpression();</span>
<span class="fc" id="L226">		List&lt;Term&gt; newInitExp = new ArrayList&lt;Term&gt;();</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">		for (Term exp : initExp) {</span>
<span class="fc" id="L228">			newInitExp.add(ts.visit(exp));</span>
<span class="fc" id="L229">		}</span>
<span class="fc" id="L230">		newLetRule.getInitExpression().addAll(newInitExp);</span>
<span class="fc" id="L231">		newLetRule.setInRule(visit(letRule.getInRule()));</span>
<span class="fc" id="L232">		return newLetRule;</span>
	}

	public Rule visit(ExtendRule extendRule) {
<span class="nc" id="L236">		ExtendRule newExtendRule = ruleFact.createExtendRule();</span>
<span class="nc" id="L237">		newExtendRule.getBoundVar().addAll(extendRule.getBoundVar());</span>
<span class="nc" id="L238">		newExtendRule.setExtendedDomain(extendRule.getExtendedDomain());</span>
<span class="nc" id="L239">		Rule newDoRule = visit(extendRule.getDoRule());</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">		assert newDoRule != null;</span>
<span class="nc" id="L241">		newExtendRule.setDoRule(newDoRule);</span>
<span class="nc" id="L242">		return newExtendRule;</span>
	}

	@Override
	public String getCode() {
<span class="fc" id="L247">		return &quot;RS&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>